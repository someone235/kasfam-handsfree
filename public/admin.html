<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Kaspa Tweets</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 2rem;
        background: #0f172a;
        color: #e2e8f0;
      }
      a {
        color: #38bdf8;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        border: 1px solid #1e293b;
        padding: 0.5rem;
        vertical-align: top;
      }
      th {
        background: #1e293b;
      }
      tr:nth-child(odd) {
        background: #0f172a;
      }
      tr:nth-child(even) {
        background: #1e293b;
      }
      form {
        margin: 0;
      }
      select,
      button,
      input {
        font: inherit;
        background: #1e293b;
        color: white;
        border: 1px solid #334155;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
      }
      button {
        cursor: pointer;
        background: #3b82f6;
        border-color: #2563eb;
      }
      button:hover {
        background: #2563eb;
      }
      button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }
      .filters {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
      }
      .filters select {
        min-width: 10rem;
      }
      .cell-content {
        max-height: 200px;
        overflow: hidden;
        position: relative;
      }
      .quote .cell-content {
        white-space: pre-line;
      }
      .cell-content.expanded {
        max-height: none;
      }
      .expand-toggle {
        display: inline-block;
        color: #38bdf8;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 0.125rem;
        text-decoration: underline;
      }
      .expand-toggle:hover {
        color: #0ea5e9;
      }
      .decision-form {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .status-icon {
        font-size: 1.2em;
      }
      .process-btn {
        font-size: 0.9em;
        padding: 0.15rem 0.4rem;
        background: #f59e0b;
        border-color: #d97706;
        margin-left: 0.5rem;
        min-width: 1.8em;
      }
      .process-btn:hover {
        background: #d97706;
      }
      .process-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .spinner {
        display: inline-block;
        width: 0.8em;
        height: 0.8em;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      #loading {
        display: none;
        color: #94a3b8;
        margin-left: 1rem;
      }
      .pagination {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-top: 1rem;
      }
      #results-summary {
        color: #94a3b8;
        margin-left: auto;
      }
      /* Modal styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        padding: 1.5rem;
        max-width: 500px;
        width: 90%;
      }
      .modal h3 {
        margin: 0 0 1rem 0;
        color: #e2e8f0;
      }
      .modal p {
        margin: 0 0 1rem 0;
        color: #94a3b8;
        font-size: 0.9em;
      }
      .preset-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .preset-btn {
        background: #334155;
        border: 1px solid #475569;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        cursor: pointer;
        color: #e2e8f0;
        font-size: 0.9em;
      }
      .preset-btn:hover {
        background: #475569;
      }
      .modal-input {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 1rem;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.25rem;
        color: #e2e8f0;
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
      }
      .modal-cancel {
        background: #475569;
        border-color: #64748b;
      }
      .preset-btn.selected {
        background: #3b82f6;
        border-color: #2563eb;
      }
      .info-icon {
        cursor: pointer;
        color: #64748b;
        font-size: 0.9em;
        margin-left: 0.4rem;
        vertical-align: middle;
      }
      .info-icon:hover {
        color: #94a3b8;
      }
      .modal.view-only .preset-btn {
        cursor: default;
        opacity: 0.7;
      }
      .modal.view-only .preset-btn:not(.selected):hover {
        background: #334155;
      }
      .modal.view-only .modal-input {
        opacity: 0.7;
      }
      .modal.view-only .modal-actions {
        display: none;
      }
      .modal-close-btn {
        background: #3b82f6;
        border-color: #2563eb;
      }
    </style>
  </head>
  <body>
    <h1>Kaspa Tweet Decisions</h1>

    <div class="filters">
      <label>
        Model approved:
        <select id="filter-approved">
          <option value="all">All</option>
          <option value="true">Approved</option>
          <option value="false">Rejected</option>
          <option value="pending">Pending (no decision)</option>
        </select>
      </label>
      <label>
        Human decision:
        <select id="filter-human">
          <option value="all">All</option>
          <option value="APPROVED">Approved</option>
          <option value="REJECTED">Rejected</option>
          <option value="UNSET">Unset</option>
        </select>
      </label>
      <label>
        Gold example:
        <select id="filter-gold">
          <option value="all">All</option>
          <option value="GOOD">Good</option>
          <option value="BAD">Bad</option>
          <option value="ANY">Any (marked)</option>
          <option value="NONE">None (unmarked)</option>
        </select>
      </label>
      <button id="refresh-btn">Refresh</button>
      <span id="loading">Loading...</span>
      <span id="gold-counts" style="margin-left: 1rem; color: #94a3b8; font-size: 0.9em;"></span>
    </div>

    <div style="margin-top: 1rem; margin-bottom: 1rem">
      <label>
        Admin Password:
        <input
          type="password"
          id="admin-password"
          placeholder="Enter password"
        />
      </label>
    </div>

    <table>
      <colgroup>
        <col /><!-- ID -->
        <col /><!-- Tweet -->
        <col style="min-width: 20%;" /><!-- Quote -->
        <col /><!-- Score -->
        <col /><!-- URL -->
        <col /><!-- Model Approved -->
        <col /><!-- Human Decision -->
        <col /><!-- Gold Example -->
        <col /><!-- Created -->
        <col /><!-- Updated -->
        <col /><!-- Actions -->
      </colgroup>
      <thead>
        <tr>
          <th>ID</th>
          <th>Tweet</th>
          <th>Quote</th>
          <th>Score</th>
          <th>URL</th>
          <th>Model Approved</th>
          <th>Human Decision</th>
          <th>Gold Example</th>
          <th>Created</th>
          <th>Updated</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tweets-body">
        <!-- Tweets will be loaded here -->
      </tbody>
    </table>

    <div class="pagination">
      <div style="display: flex; gap: 0.5rem; align-items: center">
        <button id="prev-page" type="button">Previous</button>
        <span id="page-display">Page 1</span>
        <button id="next-page" type="button">Next</button>
      </div>
      <label>
        Per page:
        <select id="page-size">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
        </select>
      </label>
      <span id="results-summary">Showing 0 of 0</span>
    </div>

    <!-- Rejection Reason Modal -->
    <div id="rejection-modal" class="modal-overlay">
      <div class="modal">
        <h3 id="modal-title">Why is this a bad example?</h3>
        <p id="modal-subtitle">Select a preset reason or write a custom one:</p>
        <div class="preset-buttons">
          <button type="button" class="preset-btn" data-reason="Rejected: low signal filler">Low signal / filler</button>
          <button type="button" class="preset-btn" data-reason="Rejected: price action focus">Price action</button>
          <button type="button" class="preset-btn" data-reason="Rejected: not about Kaspa">Not about Kaspa</button>
          <button type="button" class="preset-btn" data-reason="Rejected: L2 promotion">L2 promotion</button>
          <button type="button" class="preset-btn" data-reason="Rejected: praises individual">Praises individual</button>
          <button type="button" class="preset-btn" data-reason="Rejected: divisive/drama">Divisive / drama</button>
          <button type="button" class="preset-btn" data-reason="Rejected: generic hype">Generic hype</button>
        </div>
        <input type="text" id="custom-reason" class="modal-input" placeholder="Or type a custom reason: Rejected: ..." />
        <div class="modal-actions">
          <button type="button" id="modal-cancel" class="modal-cancel">Cancel</button>
          <button type="button" id="modal-submit">Save as BAD example</button>
        </div>
        <div class="modal-view-actions" style="display: none; justify-content: flex-end;">
          <button type="button" id="modal-close" class="modal-close-btn">Close</button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "/api/admin/tweets";
      const tweetsBody = document.getElementById("tweets-body");
      const filterApproved = document.getElementById("filter-approved");
      const filterHuman = document.getElementById("filter-human");
      const filterGold = document.getElementById("filter-gold");
      const refreshBtn = document.getElementById("refresh-btn");
      const loadingIndicator = document.getElementById("loading");
      const goldCountsDisplay = document.getElementById("gold-counts");
      const passwordInput = document.getElementById("admin-password");

      // Modal elements
      const rejectionModal = document.getElementById("rejection-modal");
      const modalContent = rejectionModal.querySelector(".modal");
      const modalTitle = document.getElementById("modal-title");
      const modalSubtitle = document.getElementById("modal-subtitle");
      const customReasonInput = document.getElementById("custom-reason");
      const modalCancelBtn = document.getElementById("modal-cancel");
      const modalSubmitBtn = document.getElementById("modal-submit");
      const modalCloseBtn = document.getElementById("modal-close");
      const modalActions = rejectionModal.querySelector(".modal-actions");
      const modalViewActions = rejectionModal.querySelector(".modal-view-actions");
      const presetBtns = rejectionModal.querySelectorAll(".preset-btn");
      let pendingGoldExampleSelect = null; // Track which select triggered the modal
      let isViewMode = false;
      const prevPageBtn = document.getElementById("prev-page");
      const nextPageBtn = document.getElementById("next-page");
      const pageDisplay = document.getElementById("page-display");
      const pageSizeSelect = document.getElementById("page-size");
      const resultsSummary = document.getElementById("results-summary");

      prevPageBtn.disabled = true;
      nextPageBtn.disabled = true;

      const paginationState = {
        page: 1,
        pageSize: Number(pageSizeSelect.value) || 20,
        totalPages: 0,
        total: 0,
        hasNextPage: false,
        hasPreviousPage: false,
      };

      function applyFiltersFromUrl() {
        const params = new URLSearchParams(window.location.search);
        setSelectFromParam(filterApproved, params.get("approved"));
        setSelectFromParam(filterHuman, params.get("humanDecision"));
        setSelectFromParam(filterGold, params.get("goldExample"));
        const urlPage = parsePositiveInteger(params.get("page"));
        const urlPageSize = parsePositiveInteger(params.get("pageSize"));

        if (urlPage) {
          paginationState.page = urlPage;
        }

        if (urlPageSize && hasPageSizeOption(urlPageSize)) {
          pageSizeSelect.value = String(urlPageSize);
          paginationState.pageSize = urlPageSize;
        }
      }

      function setSelectFromParam(selectEl, value) {
        if (!value) {
          selectEl.value = "all";
          return;
        }
        const optionExists = Array.from(selectEl.options).some(
          (opt) => opt.value === value
        );
        selectEl.value = optionExists ? value : "all";
      }

      function updateUrlFromFilters() {
        const params = new URLSearchParams(window.location.search);
        syncFilterParam(params, "approved", filterApproved.value);
        syncFilterParam(params, "humanDecision", filterHuman.value);
        syncFilterParam(params, "goldExample", filterGold.value);
        params.set("page", String(paginationState.page));
        params.set("pageSize", String(paginationState.pageSize));
        const newSearch = params.toString();
        const newUrl = `${window.location.pathname}${
          newSearch ? `?${newSearch}` : ""
        }${window.location.hash}`;
        window.history.replaceState({}, "", newUrl);
      }

      function syncFilterParam(params, key, value) {
        if (value && value !== "all") {
          params.set(key, value);
        } else {
          params.delete(key);
        }
      }

      function handleFilterChange() {
        paginationState.page = 1;
        updateUrlFromFilters();
        fetchTweets();
      }

      // load password from local storage
      const savedPassword = localStorage.getItem("kasfam_admin_password");
      if (savedPassword) {
        passwordInput.value = savedPassword;
      }

      passwordInput.addEventListener("input", (e) => {
        localStorage.setItem("kasfam_admin_password", e.target.value);
        fetchGoldCounts();
      });

      async function fetchTweets() {
        loadingIndicator.style.display = "inline";
        tweetsBody.innerHTML =
          '<tr><td colspan="11" style="text-align:center">Loading...</td></tr>';

        const params = new URLSearchParams();
        if (filterApproved.value !== "all")
          params.append("approved", filterApproved.value);
        if (filterHuman.value !== "all")
          params.append("humanDecision", filterHuman.value);
        if (filterGold.value !== "all")
          params.append("goldExample", filterGold.value);
        params.append("page", String(paginationState.page));
        params.append("pageSize", String(paginationState.pageSize));

        const password = passwordInput.value;
        if (password) {
          params.append("password", password);
        }

        try {
          const res = await fetch(`${API_BASE}?${params.toString()}`);
          if (res.status === 401) {
            tweetsBody.innerHTML = `<tr><td colspan="11" style="text-align:center; color: #ef4444;">Unauthorized: Please check your password.</td></tr>`;
            updatePagination({
              page: paginationState.page,
              pageSize: paginationState.pageSize,
              total: 0,
              totalPages: 0,
              hasNextPage: false,
              hasPreviousPage: paginationState.page > 1,
            });
            return;
          }
          if (!res.ok) throw new Error("Failed to fetch tweets");
          const payload = await res.json();
          renderTweets(payload.data || []);
          updatePagination(payload.pagination);
        } catch (err) {
          console.error(err);
          tweetsBody.innerHTML = `<tr><td colspan="11" style="text-align:center; color: #ef4444;">Error loading tweets: ${err.message}</td></tr>`;
        } finally {
          loadingIndicator.style.display = "none";
        }
      }

      function renderTweets(tweets) {
        if (tweets.length === 0) {
          showNoTweetsMessage();
          return;
        }

        tweetsBody.innerHTML = tweets
          .map((tweet) => {
            const decisionValue = tweet.humanDecision || "";
            const isPending = tweet.approved === null;
            return `
            <tr data-approved="${
              tweet.approved
            }" data-human-decision="${escapeHtml(decisionValue || "UNSET")}" data-gold-example-type="${escapeHtml(tweet.goldExampleType || "")}">
            <td>${escapeHtml(tweet.id)}</td>
            <td>
              <div class="cell-content" data-content-type="tweet">${escapeHtml(tweet.text)}</div>
              <span class="expand-toggle" data-target="tweet" style="display: none;">Show more</span>
            </td>
            <td class="quote">
              <div class="cell-content" data-content-type="quote">${escapeHtml(tweet.quote)}</div>
              <span class="expand-toggle" data-target="quote" style="display: none;">Show more</span>
            </td>
            <td class="score-cell">${escapeHtml(tweet.score ?? "")}</td>
            <td><a href="${escapeHtml(
              tweet.url
            )}" target="_blank" rel="noreferrer">link</a></td>
            <td class="status-icon">
              ${isPending ? "⏳" : tweet.approved ? "✅" : "❌"}
            </td>
            <td>
                <select class="decision-select" data-id="${escapeHtml(
                  tweet.id
                )}" data-prev-value="${escapeHtml(decisionValue)}">
                  <option value="" disabled ${
                    !decisionValue ? "selected" : ""
                  }>Choose…</option>
                  <option value="APPROVED" ${
                    decisionValue === "APPROVED" ? "selected" : ""
                  }>APPROVED</option>
                  <option value="REJECTED" ${
                    decisionValue === "REJECTED" ? "selected" : ""
                  }>REJECTED</option>
                </select>
            </td>
            <td style="white-space: nowrap;">
                <select class="gold-example-select" data-id="${escapeHtml(
                  tweet.id
                )}" data-prev-value="${escapeHtml(tweet.goldExampleType || "")}">
                  <option value="" ${!tweet.goldExampleType ? "selected" : ""}>None</option>
                  <option value="GOOD" ${tweet.goldExampleType === "GOOD" ? "selected" : ""}>GOOD</option>
                  <option value="BAD" ${tweet.goldExampleType === "BAD" ? "selected" : ""}>BAD</option>
                </select>${tweet.goldExampleCorrection ? `<span class="info-icon" data-correction="${escapeHtml(tweet.goldExampleCorrection)}">ⓘ</span>` : ""}
            </td>
            <td>${escapeHtml(new Date(tweet.createdAt).toLocaleString())}</td>
            <td>${tweet.updatedAt ? escapeHtml(new Date(tweet.updatedAt).toLocaleString()) : "-"}</td>
            <td>
              ${isPending ? `<button class="process-btn" data-id="${escapeHtml(tweet.id)}" style="margin-right: 0.5rem;">▶</button>` : ""}
              ${!isPending ? `<button type="button" class="reeval-btn" data-id="${escapeHtml(tweet.id)}">Suggest new QT</button>` : ""}
            </td>
          </tr>
        `;
          })
          .join("");
        setTimeout(updateExpandToggles, 50);
      }

      function showNoTweetsMessage(message = "No tweets found") {
        tweetsBody.innerHTML = `<tr><td colspan="11" style="text-align:center">${message}</td></tr>`;
      }

      function rowMatchesCurrentFilters(rowData) {
        if (!rowData) return true;

        if (
          filterApproved.value !== "all" &&
          rowData.approved !== filterApproved.value
        ) {
          return false;
        }

        if (filterHuman.value !== "all") {
          const currentDecision = rowData.humanDecision || "UNSET";
          if (filterHuman.value === "UNSET") {
            if (currentDecision !== "UNSET") return false;
          } else if (currentDecision !== filterHuman.value) {
            return false;
          }
        }

        // Check gold example filter
        if (filterGold.value !== "all") {
          const currentGold = rowData.goldExampleType || "";
          if (filterGold.value === "NONE" && currentGold !== "") return false;
          if (filterGold.value === "ANY" && currentGold === "") return false;
          if (filterGold.value === "GOOD" && currentGold !== "GOOD") return false;
          if (filterGold.value === "BAD" && currentGold !== "BAD") return false;
        }

        return true;
      }

      function handleDecisionChange(event) {
        const select = event.target;
        if (!select.classList.contains("decision-select")) return;

        const decision = select.value;
        if (!decision) return;

        saveDecision(select, decision);
      }

      function handleGoldExampleChange(event) {
        const select = event.target;
        if (!select.classList.contains("gold-example-select")) return;

        const type = select.value || null;

        if (type === "BAD") {
          // Show the modal to get rejection reason
          pendingGoldExampleSelect = select;
          customReasonInput.value = "";
          rejectionModal.classList.add("active");
        } else {
          // For GOOD or None, save directly without correction
          saveGoldExample(select, type, null);
        }
      }

      async function saveGoldExample(select, type, correction) {
        const id = select.dataset.id;
        const password = passwordInput.value;
        const previousValue = select.dataset.prevValue || "";

        if (!password) {
          alert("Please enter the admin password before saving.");
          select.value = previousValue;
          return;
        }

        select.disabled = true;

        try {
          const body = { type, password };
          if (correction) {
            body.correction = correction;
          }

          const res = await fetch(
            `/api/admin/tweets/${encodeURIComponent(id)}/gold-example`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            }
          );

          if (!res.ok) {
            const text = await res.text();
            alert(`Error: ${text}`);
            select.value = previousValue;
            return;
          }

          select.dataset.prevValue = type || "";

          // Update row dataset and check if it still matches filters
          const row = select.closest("tr");
          if (row) {
            row.dataset.goldExampleType = type || "";
            if (!rowMatchesCurrentFilters(row.dataset)) {
              row.remove();
              if (!tweetsBody.querySelector("tr")) {
                showNoTweetsMessage("No tweets match current filters");
              }
            }
          }

          fetchGoldCounts();
        } catch (err) {
          console.error(err);
          alert("Failed to save gold example status");
          select.value = previousValue;
        } finally {
          select.disabled = false;
        }
      }

      async function saveDecision(select, decision) {
        const id = select.dataset.id;
        const password = passwordInput.value;
        const previousValue = select.dataset.prevValue || "";

        if (!password) {
          alert("Please enter the admin password before saving.");
          select.value = previousValue;
          return;
        }

        if (!id) {
          select.value = previousValue;
          return;
        }

        select.disabled = true;

        try {
          const res = await fetch(
            `/tweets/${encodeURIComponent(id)}/human-decision`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ decision, password }),
            }
          );

          if (!res.ok) {
            const text = await res.text();
            alert(`Error: ${text}`);
            select.value = previousValue;
            return;
          }

          select.dataset.prevValue = decision;

          const row = select.closest("tr");
          if (row) {
            row.dataset.humanDecision = decision || "UNSET";
            if (!rowMatchesCurrentFilters(row.dataset)) {
              row.remove();
              if (!tweetsBody.querySelector("tr")) {
                showNoTweetsMessage("No tweets match current filters");
              }
            }
          }
        } catch (err) {
          console.error(err);
          alert("Failed to save decision");
          select.value = previousValue;
        } finally {
          select.disabled = false;
        }
      }

      async function handleProcessButtonClick(button) {
        const id = button.dataset.id;
        const password = passwordInput.value;

        if (!password) {
          alert("Please enter the admin password before processing.");
          return;
        }

        if (!id) {
          alert("Missing tweet ID for processing.");
          return;
        }

        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span>';

        try {
          const res = await fetch(`/api/admin/tweets/${encodeURIComponent(id)}/process`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ password }),
          });

          if (res.status === 401) {
            alert("Unauthorized: Please check your password.");
            return;
          }

          if (!res.ok) {
            const text = await res.text();
            alert(`Error: ${text}`);
            return;
          }

          const result = await res.json();
          alert(`Tweet processed!\nApproved: ${result.approved}\nScore: ${result.score ?? "(none)"}\nQuote: ${result.quote || "(none)"}`);
          fetchTweets();
        } catch (err) {
          console.error(err);
          alert("Failed to process tweet");
        } finally {
          button.disabled = false;
          button.innerHTML = "▶";
        }
      }

      async function handleReevalButtonClick(button) {
        const id = button.dataset.id;
        const password = passwordInput.value;

        if (!password) {
          alert("Please enter the admin password before re-evaluating.");
          return;
        }

        if (!id) {
          alert("Missing tweet ID for re-evaluation.");
          return;
        }

        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = "Thinking...";

        try {
          const res = await fetch(`/tweets/${encodeURIComponent(id)}/reeval`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ password }),
          });

          if (res.status === 401) {
            alert("Unauthorized: Please check your password.");
            return;
          }

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || "Failed to re-evaluate tweet.");
          }

          const updatedTweet = await res.json();
          const row = button.closest("tr");
          if (!row) {
            await fetchTweets();
            return;
          }

          const quoteCell = row.querySelector(".quote");
          if (quoteCell) {
            quoteCell.textContent = updatedTweet.quote ?? "";
          }

          const scoreCell = row.querySelector(".score-cell");
          if (scoreCell) {
            const scoreValue =
              typeof updatedTweet.score === "number"
                ? String(updatedTweet.score)
                : "";
            scoreCell.textContent = scoreValue;
          }

          const statusCell = row.querySelector(".status-icon");
          if (statusCell) {
            statusCell.textContent = updatedTweet.approved ? "✅" : "❌";
          }

          row.dataset.approved = String(Boolean(updatedTweet.approved));
        } catch (err) {
          const message = err instanceof Error ? err.message : String(err);
          alert(`Failed to re-evaluate tweet: ${message}`);
        } finally {
          button.disabled = false;
          button.textContent = originalLabel;
        }
      }

      function escapeHtml(value) {
        if (!value) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function updatePagination(meta = {}) {
        const page = Number(meta.page) || 1;
        const pageSize = Number(meta.pageSize) || paginationState.pageSize;
        const total = Number(meta.total) || 0;
        const totalPages = Number(meta.totalPages) || 0;
        const hasNext =
          typeof meta.hasNextPage === "boolean"
            ? meta.hasNextPage
            : totalPages !== 0 && page < totalPages;
        const hasPrev =
          typeof meta.hasPreviousPage === "boolean"
            ? meta.hasPreviousPage
            : page > 1;

        paginationState.page = page;
        paginationState.pageSize = pageSize;
        paginationState.total = total;
        paginationState.totalPages = totalPages;
        paginationState.hasNextPage = hasNext;
        paginationState.hasPreviousPage = hasPrev;

        pageDisplay.textContent =
          totalPages > 0 ? `Page ${page} of ${totalPages}` : "Page 1 of 1";
        prevPageBtn.disabled = !hasPrev;
        nextPageBtn.disabled = !hasNext;
        pageSizeSelect.value = String(pageSize);
        resultsSummary.textContent = formatResultsSummary(
          page,
          pageSize,
          total
        );
      }

      function formatResultsSummary(page, pageSize, total) {
        if (total === 0) return "Showing 0 of 0";
        const start = (page - 1) * pageSize + 1;
        if (start > total) return `Showing 0 of ${total}`;
        const end = Math.min(page * pageSize, total);
        return `Showing ${start}-${end} of ${total}`;
      }

      function parsePositiveInteger(value) {
        if (!value) return null;
        const parsed = Number.parseInt(value, 10);
        if (!Number.isFinite(parsed) || parsed <= 0) return null;
        return parsed;
      }

      function hasPageSizeOption(size) {
        return Array.from(pageSizeSelect.options).some(
          (opt) => Number(opt.value) === Number(size)
        );
      }

      prevPageBtn.addEventListener("click", () => {
        if (!paginationState.hasPreviousPage) return;
        paginationState.page -= 1;
        updateUrlFromFilters();
        fetchTweets();
      });

      nextPageBtn.addEventListener("click", () => {
        if (!paginationState.hasNextPage) return;
        paginationState.page += 1;
        updateUrlFromFilters();
        fetchTweets();
      });

      pageSizeSelect.addEventListener("change", () => {
        paginationState.pageSize = Number(pageSizeSelect.value) || 20;
        paginationState.page = 1;
        updateUrlFromFilters();
        fetchTweets();
      });

      tweetsBody.addEventListener("change", handleDecisionChange);
      tweetsBody.addEventListener("change", handleGoldExampleChange);
      tweetsBody.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLButtonElement) && !target.classList.contains('expand-toggle')) return;

        if (target.classList.contains("reeval-btn")) {
          handleReevalButtonClick(target);
        } else if (target.classList.contains("process-btn")) {
          handleProcessButtonClick(target);
        } else if (target.classList.contains("expand-toggle")) {
          handleExpandToggle(event);
        }
      });
      filterApproved.addEventListener("change", handleFilterChange);
      filterHuman.addEventListener("change", handleFilterChange);
      filterGold.addEventListener("change", handleFilterChange);
      refreshBtn.addEventListener("click", () => {
        updateUrlFromFilters();
        fetchTweets();
      });

      // cell expand/collapse functionality
      function updateExpandToggles() {
        const cells = document.querySelectorAll('.cell-content');
        cells.forEach(cell => {
          const toggle = cell.nextElementSibling;
          if (toggle && toggle.classList.contains('expand-toggle')) {
            const isOverflowing = cell.scrollHeight > cell.clientHeight;
            toggle.style.display = isOverflowing ? 'inline-block' : 'none';
          }
        });
      }

      function handleExpandToggle(event) {
        if (!event.target.classList.contains('expand-toggle')) return;

        const toggle = event.target;
        const cell = toggle.previousElementSibling;
        const isExpanded = cell.classList.contains('expanded');

        if (isExpanded) {
          cell.classList.remove('expanded');
          toggle.textContent = 'Show more';
        } else {
          cell.classList.add('expanded');
          toggle.textContent = 'Show less';
        }
      }

      async function fetchGoldCounts() {
        const password = passwordInput.value;
        const url = password
          ? `/api/admin/gold-examples/counts?password=${encodeURIComponent(password)}`
          : `/api/gold-examples/counts`;

        try {
          const res = await fetch(url);
          if (!res.ok) {
            goldCountsDisplay.textContent = "";
            return;
          }
          const data = await res.json();
          const goodCount = data.good || 0;
          const badCount = data.bad || 0;
          const maxPerType = data.maxPerType || 5;
          goldCountsDisplay.textContent = `Gold: ${badCount}/${maxPerType} BAD, ${goodCount}/${maxPerType} GOOD (most recent ${maxPerType} used)`;
        } catch (err) {
          console.error("Failed to fetch gold counts:", err);
          goldCountsDisplay.textContent = "";
        }
      }

      // Modal event handlers
      function closeModal() {
        rejectionModal.classList.remove("active");
        if (pendingGoldExampleSelect && !isViewMode) {
          // Revert to previous value if modal is cancelled
          pendingGoldExampleSelect.value = pendingGoldExampleSelect.dataset.prevValue || "";
        }
        pendingGoldExampleSelect = null;
        customReasonInput.value = "";
        // Reset view mode state
        isViewMode = false;
        modalContent.classList.remove("view-only");
        modalTitle.textContent = "Why is this a bad example?";
        modalSubtitle.textContent = "Select a preset reason or write a custom one:";
        modalActions.style.display = "flex";
        modalViewActions.style.display = "none";
        customReasonInput.readOnly = false;
        presetBtns.forEach(btn => btn.classList.remove("selected"));
      }

      function openViewModal(correction) {
        isViewMode = true;
        modalContent.classList.add("view-only");
        modalTitle.textContent = "Bad Example Reason";
        modalSubtitle.textContent = "This tweet was marked as a bad example because:";
        modalActions.style.display = "none";
        modalViewActions.style.display = "flex";
        customReasonInput.readOnly = true;

        // Check if this matches a preset and highlight it
        let matchedPreset = false;
        presetBtns.forEach(btn => {
          btn.classList.remove("selected");
          if (btn.dataset.reason === correction) {
            btn.classList.add("selected");
            matchedPreset = true;
          }
        });

        // If it's a custom reason, show it in the input
        if (!matchedPreset) {
          customReasonInput.value = correction;
        } else {
          customReasonInput.value = "";
        }

        rejectionModal.classList.add("active");
      }

      modalCancelBtn.addEventListener("click", closeModal);
      modalCloseBtn.addEventListener("click", closeModal);

      // Close modal when clicking outside
      rejectionModal.addEventListener("click", (e) => {
        if (e.target === rejectionModal) {
          closeModal();
        }
      });

      // Handle preset button clicks
      presetBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          if (isViewMode) return; // Do nothing in view mode
          const reason = btn.dataset.reason;
          if (pendingGoldExampleSelect && reason) {
            saveGoldExample(pendingGoldExampleSelect, "BAD", reason);
            rejectionModal.classList.remove("active");
            pendingGoldExampleSelect = null;
            customReasonInput.value = "";
          }
        });
      });

      // Handle info icon clicks - open in edit mode to allow changing the reason
      tweetsBody.addEventListener("click", (e) => {
        const infoIcon = e.target.closest(".info-icon");
        if (infoIcon) {
          const correction = infoIcon.dataset.correction;
          // Find the associated select element (previous sibling)
          const select = infoIcon.previousElementSibling;
          if (select && select.classList.contains("gold-example-select") && correction) {
            openEditModal(select, correction);
          }
        }
      });

      // Open modal in edit mode with pre-populated value
      function openEditModal(selectEl, currentCorrection) {
        pendingGoldExampleSelect = selectEl;
        isViewMode = false;
        modalContent.classList.remove("view-only");
        modalTitle.textContent = "Edit bad example reason";
        modalSubtitle.textContent = "Select a different reason or update the custom one:";
        modalActions.style.display = "flex";
        modalViewActions.style.display = "none";
        customReasonInput.readOnly = false;

        // Check if this matches a preset and highlight it
        let matchedPreset = false;
        presetBtns.forEach(btn => {
          btn.classList.remove("selected");
          if (btn.dataset.reason === currentCorrection) {
            btn.classList.add("selected");
            matchedPreset = true;
          }
        });

        // If it's a custom reason, show it in the input
        if (!matchedPreset) {
          customReasonInput.value = currentCorrection;
        } else {
          customReasonInput.value = "";
        }

        rejectionModal.classList.add("active");
      }

      // Handle custom submit
      modalSubmitBtn.addEventListener("click", () => {
        const customReason = customReasonInput.value.trim();
        if (!customReason) {
          alert("Please select a preset or enter a custom reason.");
          return;
        }
        // Ensure it starts with "Rejected:" for consistency
        const reason = customReason.startsWith("Rejected:") ? customReason : `Rejected: ${customReason}`;
        if (pendingGoldExampleSelect) {
          saveGoldExample(pendingGoldExampleSelect, "BAD", reason);
          rejectionModal.classList.remove("active");
          pendingGoldExampleSelect = null;
          customReasonInput.value = "";
        }
      });

      // initial load
      applyFiltersFromUrl();
      fetchTweets();
      fetchGoldCounts();

      // update expand toggles after tweets are loaded
      setTimeout(updateExpandToggles, 100);
    </script>
  </body>
</html>
