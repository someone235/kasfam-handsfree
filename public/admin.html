<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Kaspa Tweets</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 2rem;
        background: #0f172a;
        color: #e2e8f0;
      }
      a {
        color: #38bdf8;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        border: 1px solid #1e293b;
        padding: 0.5rem;
        vertical-align: top;
      }
      th {
        background: #1e293b;
      }
      tr:nth-child(odd) {
        background: #0f172a;
      }
      tr:nth-child(even) {
        background: #1e293b;
      }
      form {
        margin: 0;
      }
      select,
      button,
      input {
        font: inherit;
        background: #1e293b;
        color: white;
        border: 1px solid #334155;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
      }
      button {
        cursor: pointer;
        background: #3b82f6;
        border-color: #2563eb;
      }
      button:hover {
        background: #2563eb;
      }
      button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }
      .filters {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
      }
      .filters select {
        min-width: 10rem;
      }
      .quote {
        white-space: pre-line;
      }
      .decision-form {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .status-icon {
        font-size: 1.2em;
      }
      #loading {
        display: none;
        color: #94a3b8;
        margin-left: 1rem;
      }
      .pagination {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-top: 1rem;
      }
      #results-summary {
        color: #94a3b8;
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <h1>Kaspa Tweet Decisions</h1>

    <div class="filters">
      <label>
        Model approved:
        <select id="filter-approved">
          <option value="all">All</option>
          <option value="true">Approved</option>
          <option value="false">Rejected</option>
        </select>
      </label>
      <label>
        Human decision:
        <select id="filter-human">
          <option value="all">All</option>
          <option value="APPROVED">Approved</option>
          <option value="REJECTED">Rejected</option>
          <option value="UNSET">Unset</option>
        </select>
      </label>
      <button id="refresh-btn">Refresh</button>
      <span id="loading">Loading...</span>
    </div>

    <div style="margin-top: 1rem; margin-bottom: 1rem">
      <label>
        Admin Password:
        <input
          type="password"
          id="admin-password"
          placeholder="Enter password"
        />
      </label>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Tweet</th>
          <th>Quote</th>
          <th>Score</th>
          <th>URL</th>
          <th>Model Approved</th>
          <th>Human Decision</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tweets-body">
        <!-- Tweets will be loaded here -->
      </tbody>
    </table>

    <div class="pagination">
      <div style="display: flex; gap: 0.5rem; align-items: center">
        <button id="prev-page" type="button">Previous</button>
        <span id="page-display">Page 1</span>
        <button id="next-page" type="button">Next</button>
      </div>
      <label>
        Per page:
        <select id="page-size">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
        </select>
      </label>
      <span id="results-summary">Showing 0 of 0</span>
    </div>

    <script>
      const API_BASE = "/api/tweets";
      const tweetsBody = document.getElementById("tweets-body");
      const filterApproved = document.getElementById("filter-approved");
      const filterHuman = document.getElementById("filter-human");
      const refreshBtn = document.getElementById("refresh-btn");
      const loadingIndicator = document.getElementById("loading");
      const passwordInput = document.getElementById("admin-password");
      const prevPageBtn = document.getElementById("prev-page");
      const nextPageBtn = document.getElementById("next-page");
      const pageDisplay = document.getElementById("page-display");
      const pageSizeSelect = document.getElementById("page-size");
      const resultsSummary = document.getElementById("results-summary");

      prevPageBtn.disabled = true;
      nextPageBtn.disabled = true;

      const paginationState = {
        page: 1,
        pageSize: Number(pageSizeSelect.value) || 20,
        totalPages: 0,
        total: 0,
        hasNextPage: false,
        hasPreviousPage: false,
      };

      function applyFiltersFromUrl() {
        const params = new URLSearchParams(window.location.search);
        setSelectFromParam(filterApproved, params.get("approved"));
        setSelectFromParam(filterHuman, params.get("humanDecision"));
        const urlPage = parsePositiveInteger(params.get("page"));
        const urlPageSize = parsePositiveInteger(params.get("pageSize"));

        if (urlPage) {
          paginationState.page = urlPage;
        }

        if (urlPageSize && hasPageSizeOption(urlPageSize)) {
          pageSizeSelect.value = String(urlPageSize);
          paginationState.pageSize = urlPageSize;
        }
      }

      function setSelectFromParam(selectEl, value) {
        if (!value) {
          selectEl.value = "all";
          return;
        }
        const optionExists = Array.from(selectEl.options).some(
          (opt) => opt.value === value
        );
        selectEl.value = optionExists ? value : "all";
      }

      function updateUrlFromFilters() {
        const params = new URLSearchParams(window.location.search);
        syncFilterParam(params, "approved", filterApproved.value);
        syncFilterParam(params, "humanDecision", filterHuman.value);
        params.set("page", String(paginationState.page));
        params.set("pageSize", String(paginationState.pageSize));
        const newSearch = params.toString();
        const newUrl = `${window.location.pathname}${
          newSearch ? `?${newSearch}` : ""
        }${window.location.hash}`;
        window.history.replaceState({}, "", newUrl);
      }

      function syncFilterParam(params, key, value) {
        if (value && value !== "all") {
          params.set(key, value);
        } else {
          params.delete(key);
        }
      }

      function handleFilterChange() {
        paginationState.page = 1;
        updateUrlFromFilters();
        fetchTweets();
      }

      // Load password from local storage
      const savedPassword = localStorage.getItem("kasfam_admin_password");
      if (savedPassword) {
        passwordInput.value = savedPassword;
      }

      passwordInput.addEventListener("input", (e) => {
        localStorage.setItem("kasfam_admin_password", e.target.value);
      });

      async function fetchTweets() {
        loadingIndicator.style.display = "inline";
        tweetsBody.innerHTML =
          '<tr><td colspan="9" style="text-align:center">Loading...</td></tr>';

        const params = new URLSearchParams();
        if (filterApproved.value !== "all")
          params.append("approved", filterApproved.value);
        if (filterHuman.value !== "all")
          params.append("humanDecision", filterHuman.value);
        params.append("page", String(paginationState.page));
        params.append("pageSize", String(paginationState.pageSize));

        const password = passwordInput.value;
        if (password) {
          params.append("password", password);
        }

        try {
          const res = await fetch(`${API_BASE}?${params.toString()}`);
          if (res.status === 401) {
            tweetsBody.innerHTML = `<tr><td colspan="9" style="text-align:center; color: #ef4444;">Unauthorized: Please check your password.</td></tr>`;
            updatePagination({
              page: paginationState.page,
              pageSize: paginationState.pageSize,
              total: 0,
              totalPages: 0,
              hasNextPage: false,
              hasPreviousPage: paginationState.page > 1,
            });
            return;
          }
          if (!res.ok) throw new Error("Failed to fetch tweets");
          const payload = await res.json();
          renderTweets(payload.data || []);
          updatePagination(payload.pagination);
        } catch (err) {
          console.error(err);
          tweetsBody.innerHTML = `<tr><td colspan="9" style="text-align:center; color: #ef4444;">Error loading tweets: ${err.message}</td></tr>`;
        } finally {
          loadingIndicator.style.display = "none";
        }
      }

      function renderTweets(tweets) {
        if (tweets.length === 0) {
          showNoTweetsMessage();
          return;
        }

        tweetsBody.innerHTML = tweets
          .map((tweet) => {
            const decisionValue = tweet.humanDecision || "";
            return `
            <tr data-approved="${
              tweet.approved
            }" data-human-decision="${escapeHtml(decisionValue || "UNSET")}">
            <td>${escapeHtml(tweet.id)}</td>
            <td>${escapeHtml(tweet.text)}</td>
            <td class="quote">${escapeHtml(tweet.quote)}</td>
            <td class="score-cell">${escapeHtml(tweet.score ?? "")}</td>
            <td><a href="${escapeHtml(
              tweet.url
            )}" target="_blank" rel="noreferrer">link</a></td>
            <td class="status-icon">${tweet.approved ? "✅" : "❌"}</td>
            <td>
                <select class="decision-select" data-id="${escapeHtml(
                  tweet.id
                )}" data-prev-value="${escapeHtml(decisionValue)}">
                  <option value="" disabled ${
                    !decisionValue ? "selected" : ""
                  }>Choose…</option>
                  <option value="APPROVED" ${
                    decisionValue === "APPROVED" ? "selected" : ""
                  }>APPROVED</option>
                  <option value="REJECTED" ${
                    decisionValue === "REJECTED" ? "selected" : ""
                  }>REJECTED</option>
                </select>
            </td>
            <td>${escapeHtml(new Date(tweet.createdAt).toLocaleString())}</td>
            <td>
              <button type="button" class="reeval-btn" data-id="${escapeHtml(
                tweet.id
              )}">Suggest new QT</button>
            </td>
          </tr>
        `;
          })
          .join("");
      }

      function showNoTweetsMessage(message = "No tweets found") {
        tweetsBody.innerHTML = `<tr><td colspan="9" style="text-align:center">${message}</td></tr>`;
      }

      function rowMatchesCurrentFilters(rowData) {
        if (!rowData) return true;

        if (
          filterApproved.value !== "all" &&
          rowData.approved !== filterApproved.value
        ) {
          return false;
        }

        if (filterHuman.value !== "all") {
          const currentDecision = rowData.humanDecision || "UNSET";
          if (filterHuman.value === "UNSET") {
            if (currentDecision !== "UNSET") return false;
          } else if (currentDecision !== filterHuman.value) {
            return false;
          }
        }

        return true;
      }

      function handleDecisionChange(event) {
        const select = event.target;
        if (!select.classList.contains("decision-select")) return;

        const decision = select.value;
        if (!decision) return;

        saveDecision(select, decision);
      }

      async function saveDecision(select, decision) {
        const id = select.dataset.id;
        const password = passwordInput.value;
        const previousValue = select.dataset.prevValue || "";

        if (!password) {
          alert("Please enter the admin password before saving.");
          select.value = previousValue;
          return;
        }

        if (!id) {
          select.value = previousValue;
          return;
        }

        select.disabled = true;

        try {
          const res = await fetch(
            `/tweets/${encodeURIComponent(id)}/human-decision`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ decision, password }),
            }
          );

          if (!res.ok) {
            const text = await res.text();
            alert(`Error: ${text}`);
            select.value = previousValue;
            return;
          }

          select.dataset.prevValue = decision;

          const row = select.closest("tr");
          if (row) {
            row.dataset.humanDecision = decision || "UNSET";
            if (!rowMatchesCurrentFilters(row.dataset)) {
              row.remove();
              if (!tweetsBody.querySelector("tr")) {
                showNoTweetsMessage("No tweets match current filters");
              }
            }
          }
        } catch (err) {
          console.error(err);
          alert("Failed to save decision");
          select.value = previousValue;
        } finally {
          select.disabled = false;
        }
      }

      async function handleReevalButtonClick(button) {
        const id = button.dataset.id;
        const password = passwordInput.value;

        if (!password) {
          alert("Please enter the admin password before re-evaluating.");
          return;
        }

        if (!id) {
          alert("Missing tweet ID for re-evaluation.");
          return;
        }

        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = "Thinking...";

        try {
          const res = await fetch(`/tweets/${encodeURIComponent(id)}/reeval`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ password }),
          });

          if (res.status === 401) {
            alert("Unauthorized: Please check your password.");
            return;
          }

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || "Failed to re-evaluate tweet.");
          }

          const updatedTweet = await res.json();
          const row = button.closest("tr");
          if (!row) {
            await fetchTweets();
            return;
          }

          const quoteCell = row.querySelector(".quote");
          if (quoteCell) {
            quoteCell.textContent = updatedTweet.quote ?? "";
          }

          const scoreCell = row.querySelector(".score-cell");
          if (scoreCell) {
            const scoreValue =
              typeof updatedTweet.score === "number"
                ? String(updatedTweet.score)
                : "";
            scoreCell.textContent = scoreValue;
          }

          const statusCell = row.querySelector(".status-icon");
          if (statusCell) {
            statusCell.textContent = updatedTweet.approved ? "✅" : "❌";
          }

          row.dataset.approved = String(Boolean(updatedTweet.approved));
        } catch (err) {
          const message = err instanceof Error ? err.message : String(err);
          alert(`Failed to re-evaluate tweet: ${message}`);
        } finally {
          button.disabled = false;
          button.textContent = originalLabel;
        }
      }

      function escapeHtml(value) {
        if (!value) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function updatePagination(meta = {}) {
        const page = Number(meta.page) || 1;
        const pageSize = Number(meta.pageSize) || paginationState.pageSize;
        const total = Number(meta.total) || 0;
        const totalPages = Number(meta.totalPages) || 0;
        const hasNext =
          typeof meta.hasNextPage === "boolean"
            ? meta.hasNextPage
            : totalPages !== 0 && page < totalPages;
        const hasPrev =
          typeof meta.hasPreviousPage === "boolean"
            ? meta.hasPreviousPage
            : page > 1;

        paginationState.page = page;
        paginationState.pageSize = pageSize;
        paginationState.total = total;
        paginationState.totalPages = totalPages;
        paginationState.hasNextPage = hasNext;
        paginationState.hasPreviousPage = hasPrev;

        pageDisplay.textContent =
          totalPages > 0 ? `Page ${page} of ${totalPages}` : "Page 1 of 1";
        prevPageBtn.disabled = !hasPrev;
        nextPageBtn.disabled = !hasNext;
        pageSizeSelect.value = String(pageSize);
        resultsSummary.textContent = formatResultsSummary(
          page,
          pageSize,
          total
        );
      }

      function formatResultsSummary(page, pageSize, total) {
        if (total === 0) return "Showing 0 of 0";
        const start = (page - 1) * pageSize + 1;
        if (start > total) return `Showing 0 of ${total}`;
        const end = Math.min(page * pageSize, total);
        return `Showing ${start}-${end} of ${total}`;
      }

      function parsePositiveInteger(value) {
        if (!value) return null;
        const parsed = Number.parseInt(value, 10);
        if (!Number.isFinite(parsed) || parsed <= 0) return null;
        return parsed;
      }

      function hasPageSizeOption(size) {
        return Array.from(pageSizeSelect.options).some(
          (opt) => Number(opt.value) === Number(size)
        );
      }

      prevPageBtn.addEventListener("click", () => {
        if (!paginationState.hasPreviousPage) return;
        paginationState.page -= 1;
        updateUrlFromFilters();
        fetchTweets();
      });

      nextPageBtn.addEventListener("click", () => {
        if (!paginationState.hasNextPage) return;
        paginationState.page += 1;
        updateUrlFromFilters();
        fetchTweets();
      });

      pageSizeSelect.addEventListener("change", () => {
        paginationState.pageSize = Number(pageSizeSelect.value) || 20;
        paginationState.page = 1;
        updateUrlFromFilters();
        fetchTweets();
      });

      tweetsBody.addEventListener("change", handleDecisionChange);
      tweetsBody.addEventListener("click", (event) => {
        const target = event.target;
        if (
          target instanceof HTMLButtonElement &&
          target.classList.contains("reeval-btn")
        ) {
          handleReevalButtonClick(target);
        }
      });
      filterApproved.addEventListener("change", handleFilterChange);
      filterHuman.addEventListener("change", handleFilterChange);
      refreshBtn.addEventListener("click", () => {
        updateUrlFromFilters();
        fetchTweets();
      });

      // Initial load
      applyFiltersFromUrl();
      fetchTweets();
    </script>
  </body>
</html>
